name: Build and Push Docker Image

permissions:
  packages: write
  contents: read

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies (yq)
      run: sudo apt-get install -y jq curl

    - name: Log in to GitHub Container Registry (GHCR)
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin

    - name: Extract `BUILD_FROM` from `build.yaml`
      id: extract_base
      run: echo "BUILD_FROM=$(yq eval '.build_from.amd64' dozzle/build.yaml)" >> $GITHUB_ENV

    - name: Build the Docker image
      run: |
        IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/homeassistant-dozzle-addon"
        IMAGE_NAME=$(echo "$IMAGE_NAME" | tr '[:upper:]' '[:lower:]')  # ✅ Conversion en minuscules

        # Build the image using the correct base image
        docker build --build-arg BUILD_FROM=$BUILD_FROM -t $IMAGE_NAME:latest -f dozzle/Dockerfile .
        docker build --build-arg BUILD_FROM=$BUILD_FROM -t $IMAGE_NAME:${{ github.sha }} -f dozzle/Dockerfile .

    - name: Push Docker image to GHCR
      run: |
        IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/homeassistant-dozzle-addon"
        IMAGE_NAME=$(echo "$IMAGE_NAME" | tr '[:upper:]' '[:lower:]')  # ✅ Conversion en minuscules

        docker push $IMAGE_NAME:latest
        docker push $IMAGE_NAME:${{ github.sha }}
        
    - name: Clear Docker cache
      run: docker builder prune -af
